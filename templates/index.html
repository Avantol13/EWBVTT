<script src="https://unpkg.com/konva@3.1.0/konva.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.2.0/socket.io.js"></script>
<script type="text/javascript" src="./test.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css">
<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
<link rel="stylesheet" type="text/css" href="./test.css">
<!DOCTYPE html>
<html>
<head>
    <title></title>
    <div id="container"></div>
    <div id="log"></div>
    <div id="emit"></div>
    <div id="broadcast"></div>
    <div id="dialogs"></div>
</head>
<body>
</body>
</html>

<script type="text/javascript">
var width = window.innerWidth;
var height = window.innerHeight;
var shadowOffset = 20;
var tween = null;
var blockSnapSize = 50;

var socket = io.connect('http://' + document.domain + ':' + location.port + '/test');

  socket.on('updated entity', function(data) {
      let entity_id = data.id;

      console.log(`updating ${entity_id}`);
      var shape = stage.find(`#${entity_id}`)[0];
      if (shape) {
        shape.attrs = data;
        layer.draw();
      }

      var keys = Object.keys(data);
      ul = $('<ul style="list-style-type: none;">');
      for (var i = 0; i < keys.length; i++){
          var key = keys[i];
          ul.append("<li><code><em>" + key + ":</em> " + data[key] + "</code></li>");
      }
      $( `#${entity_id}` ).html(ul);
  });

var shadowRectangle = new Konva.Rect({
  x: 0,
  y: 0,
  width: blockSnapSize * 1,
  height: blockSnapSize * 1,
  fill: '#888888',
  opacity: 0.3,
  stroke: '#999999',
  strokeWidth: 3
});

// https://stackoverflow.com/a/2117523
function uuidv4() {
  return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c =>
    (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
  )
}

function getEntityValues(raw_entity) {
  if (raw_entity.className == "Rect") {
    // konva gets really upset if these arent numbers
    if(isNaN(raw_entity.x)) throw "x not a number";
    if(isNaN(raw_entity.y)) throw "y not a number";
    raw_entity.x = Number(raw_entity.x);
    raw_entity.y = Number(raw_entity.y);
    raw_entity.height = Number(raw_entity.height);
    raw_entity.width = Number(raw_entity.width);
    raw_entity.shadowBlur = Number(raw_entity.shadowBlur);
    raw_entity.shadowOffsetX = Number(raw_entity.shadowOffsetX);
    raw_entity.shadowOffsetY = Number(raw_entity.shadowOffsetY);
    raw_entity.shadowOpacity = Number(raw_entity.shadowOpacity);
    raw_entity.strokeWidth = Number(raw_entity.strokeWidth);
  }

  return raw_entity

}

function updateEntity(raw_entity) {
  let entity_id = raw_entity.id;

  console.log(`updating ${entity_id}`);
  var shape = stage.find(`#${entity_id}`)[0];
  if (shape) {
    try {
      shape.attrs = getEntityValues(raw_entity);
      layer.draw();
    } catch(err) {
      console.log(`Could not update ${entity_id}. Error: ${err}`);
    }
  }
}


function newEntity(raw_entity, layer, stage) {
  console.log(`new: `);
  console.log(raw_entity);
  let entity;
  if (raw_entity.className == "Rect") {
    var shadowEntity = new Konva.Rect({
      x: 0,
      y: 0,
      width: blockSnapSize * 1,
      height: blockSnapSize * 1,
      fill: '#888888',
      opacity: 0.3,
      stroke: '#999999',
      strokeWidth: 3
    });

    let entity_values;
    try {
      entity_values = getEntityValues(raw_entity);
    } catch(err) {
      console.log(`Could not create new entity. Error: ${err}`);
      return;
    }

    entity = new Konva.Rect(entity_values);
  } else {
    console.log(`could not determine class for ${raw_entity}`);
    return;
  }

  let entity_id = entity.attrs.id;

  entity.on('dragstart', (e) => {
    shadowEntity.show();
    shadowEntity.moveToTop();
    entity.moveToTop();
  });
  entity.on('dragend', (e) => {
    entity.position({
      x: Math.round(entity.x() / blockSnapSize) * blockSnapSize,
      y: Math.round(entity.y() / blockSnapSize) * blockSnapSize
    });
    stage.batchDraw();
    shadowEntity.hide();
    socket.emit('update entity', entity);
  });
  entity.on('dragmove', (e) => {
    shadowEntity.position({
      x: Math.round(entity.x() / blockSnapSize) * blockSnapSize,
      y: Math.round(entity.y() / blockSnapSize) * blockSnapSize
    });
    stage.batchDraw();
  });
  entity.on('click', (e) => {
      if (e.evt.button === 2) {
        if (! $( `div[aria-describedby='${entity_id}']` ).length) {
            let content = `
                <div id="${entity_id}" title="Basic dialog" class="ui-dialog ui-corner-all ui-widget ui-widget-content ui-front ui-dialog-buttons ui-draggable ui-resizable">
                  <p>This is the default dialog ${entity_id}</p>
                </div>
            `;
            $( "#dialogs" ).append( content );
            socket.emit('update entity', entity);
            $( `#${entity_id}` ).dialog({
                buttons: [
                  {
                    text: "Save Updates",
                    icon: "ui-icon-disk",
                    // showText: false,
                    click: function() {
                      console.log(`saving ${entity_id}...`);
                      // entity.fill("#222888");
                      entity.attrs.fill = "#222888";
                      layer.draw();
                      socket.emit('update entity', entity);
                    }
                  }
                ]
              });
        }
        $( `#${entity_id}` ).dialog('open');
      }
    });
  layer.add(entity);
  layer.draw();
}

function newRectangle(x, y, layer, stage, entity_id=null) {
  entity_id = entity_id || uuidv4();
  let rectangle = new Konva.Rect({
    id: entity_id,
    x: x,
    y: y,
    width: blockSnapSize * 1,
    height: blockSnapSize * 1,
    fill: '#fff',
    stroke: '#ddd',
    strokeWidth: 1,
    shadowColor: 'black',
    shadowBlur: 2,
    shadowOffset: {x : 1, y : 1},
    shadowOpacity: 0.4,
    draggable: true
  });
  rectangle.on('dragstart', (e) => {
    shadowRectangle.show();
    shadowRectangle.moveToTop();
    rectangle.moveToTop();
  });
  rectangle.on('dragend', (e) => {
    rectangle.position({
      x: Math.round(rectangle.x() / blockSnapSize) * blockSnapSize,
      y: Math.round(rectangle.y() / blockSnapSize) * blockSnapSize
    });
    stage.batchDraw();
    shadowRectangle.hide();
    socket.emit('update entity', rectangle);
  });
  rectangle.on('dragmove', (e) => {
    shadowRectangle.position({
      x: Math.round(rectangle.x() / blockSnapSize) * blockSnapSize,
      y: Math.round(rectangle.y() / blockSnapSize) * blockSnapSize
    });
    stage.batchDraw();
  });
  rectangle.on('click', (e) => {
      if (e.evt.button === 2) {
        if (! $( `div[aria-describedby='${entity_id}']` ).length) {
            let content = `
                <div id="${entity_id}" title="Basic dialog" class="ui-dialog ui-corner-all ui-widget ui-widget-content ui-front ui-dialog-buttons ui-draggable ui-resizable">
                  <p>This is the default dialog ${entity_id}</p>
                </div>
            `;
            $( "#dialogs" ).append( content );
            socket.emit('update entity', rectangle);
            $( `#${entity_id}` ).dialog({
                buttons: [
                  {
                    text: "Save Updates",
                    icon: "ui-icon-disk",
                    // showText: false,
                    click: function() {
                      console.log(`saving ${entity_id}...`);
                      rectangle.attrs.fill = "#222888";
                      layer.draw();
                      socket.emit('update entity', rectangle);
                    }
                  }
                ]
              });
        }
        $( `#${entity_id}` ).dialog('open');
      }
    });
  layer.add(rectangle);
}

var stage = new Konva.Stage({
  container: 'container',
  width: width,
  height: height
});

var gridLayer = new Konva.Layer();
var padding = blockSnapSize;
console.log(width, padding, width / padding);
for (var i = 0; i < width / padding; i++) {
  gridLayer.add(new Konva.Line({
    points: [Math.round(i * padding) + 0.5, 0, Math.round(i * padding) + 0.5, height],
    stroke: '#ddd',
    strokeWidth: 1,
  }));
}

gridLayer.add(new Konva.Line({points: [0,0,10,10]}));
for (var j = 0; j < height / padding; j++) {
  gridLayer.add(new Konva.Line({
    points: [0, Math.round(j * padding), width, Math.round(j * padding)],
    stroke: '#ddd',
    strokeWidth: 0.5,
  }));
}

var layer = new Konva.Layer();
shadowRectangle.hide();
layer.add(shadowRectangle);

$.getJSON( "/api/entities", function( response ) {
  for (var i = 0; i < response.entities.length; i++) {
    newEntity(response.entities[i], layer, stage);
  }
});

newRectangle(blockSnapSize * 3, blockSnapSize * 3, layer, stage);

stage.add(gridLayer);
stage.add(layer);

// do not show context menu on right click
stage.on('contentContextmenu', (e) => {
  e.evt.preventDefault();
});


</script>